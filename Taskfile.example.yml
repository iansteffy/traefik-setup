# https://taskfile.dev

version: '3'

vars:
  INSTALL: > 
    The install task will install dependencies (npm, virtualenv, …), and make sure an initial config exists.
  UPDATE: > 
    Will use the necessary tools to make sure the project is up to date. 
    This means for example running database migrations..
  RUN: >
    Starts the local development server, most of the time we will use something like http://localhost:8000/ for this. 
    The development server may be started inside a docker container using docker-compose.
  STOP: >
    Stops the project (`npm run` commands, detached running docker containers, etc.)

tasks:
  install:
    desc: '{{.INSTALL}}'
    cmds:
      - cd frontend && npm install
      - cd scanners && ./build-docker-base.sh
      
  update:
    desc: '{{.UPDATE}}'
    cmds:
      - docker compose pull
      - cd frontend && npm update
      - echo "Running database migrations if needed..."
      - docker compose exec backend python manage.py migrate || echo "No backend migrations to run"

  run:
    desc: '{{.RUN}}'
    cmds:
      - docker compose up --force-recreate --build --remove-orphans -d
      - cd frontend && npm run dev

  stop:
    desc: "{{.STOP}}"
    cmds:
      - docker compose stop
      - |
        cd frontend
        PORT=$(node -e "console.log(Number(process.env.PORT) || 6006)")
        lsof -ti:$PORT | xargs -r kill -TERM || true
        
  test:
    desc: "Run all tests"
    cmds:
      - cmd: |
          if docker compose ps -q | grep -q .; then
            echo "Containers already running → skipping compose up"
          else
            echo "No containers running → starting them"
            docker compose up --force-recreate --build --remove-orphans -d
          fi
      - uv run pytest

  clean:
    desc: "Remove any files installed by the project setup"
    cmds:
      - cd frontend && rm -rf node_modules
      - docker compose down --volumes --remove-orphans
      - docker system prune -f

  lint:
    desc: "Execute the linter and check coding guidelines"
    cmds:
      - cd frontend && npm run lint
      - docker compose exec backend flake8 . || echo "No backend linting configured"
